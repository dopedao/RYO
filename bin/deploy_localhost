#!/bin/bash
set -eu

# Flow:
## The Controller is the only unchangeable contract.
## First deploy Arbiter.
## Then send the Arbiter address during Controller deployment.
## Then deploy Controller address during module deployments.

# Public keys of wallets.
declare -i AdminPubKey=12345678987654321
declare -i User00PubKey=456456456
# Admin account contract
AdminAccount=$(nile deploy Account $AdminPubKey \
    --alias AdminAccount --network localhost)
AdminAddress=$(echo -e ${AdminAccount} | grep -o -m 1 '\b0x\w*' | head -1)

# Arbiter contract (controlled by Admin)
Arbiter=$(nile deploy Arbiter --alias Arbiter)
ArbiterAddress=$(echo -e ${Arbiter} | grep -o -m 1 '\b0x\w*' | head -1)

# Module controller contract (controlled by Arbiter)
ModuleController=$(nile deploy ModuleController ${ArbiterAddress} \
    --alias ModuleController --network localhost)
ModuleControllerAddress=$(echo -e ${ModuleController} | grep -o -m 1 '\b0x\w*' | head -1)


nile deploy 01_DopeWars $ModuleControllerAddress \
    --alias 01_DopeWars --network localhost

nile deploy 02_LocationOwned $ModuleControllerAddress \
    --alias 02_LocationOwned --network localhost

nile deploy 03_UserOwned $ModuleControllerAddress \
    --alias 03_UserOwned --network localhost

nile deploy 04_UserRegistry $ModuleControllerAddress \
    --alias 04_UserRegistry --network localhost

nile deploy 05_Combat $ModuleControllerAddress \
    --alias 05_Combat --network localhost

nile deploy 06_DrugLord $ModuleControllerAddress \
    --alias 06_DrugLord --network localhost

nile deploy 07_PseudoRandom $ModuleControllerAddress \
    --alias 07_PseudoRandom --network localhost

# Account (below). This (admin) account will control the Arbiter
# and will be deployed with STARK-friendly ECDSA keypair(s). The
# key(s) will then be used to sign messages that go to the Account.
# The Account checks the signature(s) then passes the transaction data
# to the Arbiter. The Arbiter may then do things like call the
# ModuleController with information about a new module address.


nile deploy Account $User00PubKey \
    --alias User00Account --network localhost

